# Plan: Laravel blog → Go stack

## 1) Текущее состояние (краткий аудит)

- Ядро: PHP 8.2, Laravel (composer: `laravel/framework ^12.0`).
- Контейнеры: `compose.yml` с `traefik`, `php-fpm`, `mysql`. PHP-FPM собирается из `app-laravel/Dockerfile`;
  используется том для кода.
- БД: MySQL (порт 8989 проброшен на 3306). Много миграций для блог-ядра (users, posts, categories, tags, comments,
  likes, subscriptions, visitors, portfolios, incomings, aphorism и др.).
- Пакеты/модули:
    - `packages/shop` (категории, продукты, заказы, админ-часть для них) — опциональный модуль интернет-магазина.
    - `packages/chat` (Ratchet WebSocket чат + контроллеры, консольная команда запуска сервера). Pusher подключен как
      вариант.
    - `packages/frontparts` — подключён в autoload, но в дереве не просматривался (проверить
      актуальность/использование).
- Функциональность блога (по роутам и моделям):
    - Публичные страницы: главная (`HomeController@index`: переключается `/posts` или `/shop` по `APP_MAIN_MODULE`),
      список постов, пост по slug/id, теги и категории, поиск, политика/контакты, sitemap генерация.
    - Взаимодействие: комментарии, лайки (cookie `likedPostToday{id}`), подписки (email верификация есть в миграциях),
      счётчик просмотров, привязка «афоризма дня» к посту.
    - Админ: CRUD для категорий, тегов, пользователей, постов, комментариев, портфолио, входящих, подписчиков. Доступ
      через `AdminMiddleware` (проверка `user.is_admin` + логирование действий).
    - Авторизация: сессии, `bcrypt` (конфиг `config/hashing.php`), email verification.
    - Статика и шаблоны: Blade-шаблоны (включая shop), ассеты через `webpack.mix.js`, публичная статика в `public/*`.
- Интеграции и инструменты:
    - Документация/инструменты: `l5-swagger` (генерация OpenAPI), Telescope/Clockwork/Debugbar, PhpStan, Rector,
      PHPUnit.
    - Библиотеки: Guzzle, Doctrine DBAL, spatie/laravel-html, maatwebsite/excel, jenssegers/agent, pusher,
      vearutop/php-obscene-censor-rus.
    - Логирование: кастомный канал `by_user_logs` (пер-пользовательские логи в
      `storage/logs/by_user/{id}/YYYY-MM-DD.log`).

Вывод: ядро — это классический блог с админкой, лайками/комментариями и базовой аналитикой/учётом визитов. Отдельные модули (shop, chat) можно вывести в поздние этапы миграции.
---

## 2) Рекомендованный стек на Go

- Версия: Go 1.22+
- Веб-слой:
    - Роутер/веб-фреймворк: `chi` (минимализм, middlewares) или `gin` (популярность/экосистема). Рекомендация: `chi` для
      SSR и простоты, `gin` — если нужен прирост удобств/плагины.
    - Шаблоны: стандартный `html/template` (экранирует HTML по умолчанию). Для удобства можно добавить функции (sprig)
      или рассмотреть `a-h/templ`, если потребуется компонентный подход.
    - Middleware: `chi/middleware` (recoverer, request-id, realip, timeout), CORS (`github.com/rs/cors` или
      `gin-contrib/cors`). CSRF — `gorilla/csrf` для админ-форм.
- Данные:
    - Драйвер: `go-sql-driver/mysql` (сохранить MySQL для бесшовной миграции). Альтернатива: перейти на Postgres (#доп.
      этап).
    - Доступ к данным: `sqlc` (типобезопасные запросы по SQL) или `GORM` (быстрый старт). Рекомендация: `sqlc` для
      предсказуемости и производительности, `GORM` — если важнее скорость разработки.
    - Миграции: `golang-migrate/migrate` (CLI + миграции в контейнере).
    - Кэш: встроенно — позже Redis (`gomodule/redigo`/`go-redis`) при необходимости.
- Аутентификация и сессии:
    - Сессии: `gorilla/sessions` (cookie store) или «своё» поверх `net/http` + подписанные/зашифрованные cookies.
    - Пароли: `bcrypt` (`golang.org/x/crypto/bcrypt`) — совместим с текущими hash.
    - Email verification: отдельные токены и письма через SMTP/провайдера.
- Рилтайм и задачи:
    - WebSocket: `gorilla/websocket` или `nhooyr.io/websocket` (портировать чат из Ratchet).
    - Очереди/фоновые задачи: `hibiken/asynq` + Redis или лёгкие goroutines + cron (`robfig/cron/v3`) для простых задач.
- Почта и файлы:
    - SMTP: `github.com/wneessen/go-mail` или API (Mailgun/Sendgrid).
    - Хранилище файлов: локально + возможность S3 (AWS SDK v2, MinIO).
- Наблюдаемость:
    - Логирование: `slog` (stdlib) или `zerolog` (структурированные логи, JSON). Поддержать пер-пользовательские логи —
      middleware, пишущее в файл по userID (как в Laravel).
    - Метрики/трейсинг: Prometheus (`promhttp`), OpenTelemetry (`otelhttp`). Профилирование: `net/http/pprof`.
- Документация API:
    - `swaggo/swag` для автогенерации OpenAPI (аналог l5-swagger).
- Тестирование:
    - `testing`, `testify`, `httptest` для handler’ов и репозиториев.
- Сборка/доставка:
    - Мультистейдж Dockerfile (tiny runtime, non-root). Compose: заменить `php-fpm` на `go-app`, оставить `mysql`,
      Traefik без изменений.

---

## 3) Стратегия миграции (итеративно)

1) Инициализация сервиса

- Базовый каркас: роутер, конфиг (env → struct), шаблоны, middleware, логирование, HEALTH endpoint.
- Dockerfile + сервис `go-app` в `compose.yml`. Параллельный запуск рядом с Laravel под своим роутом/хостом в Traefik.

2) Схема БД и доступ к данным

- Отразить текущие таблицы (users, posts, categories, tags, comments, likes, subscriptions, visitors,
  post_tags/post_likes и пр.).
- Подготовить миграции в Go (на старте можно использовать имеющуюся БД; миграции — для будущих изменений).
- Выбрать `sqlc` или `GORM`. Для скорости старта допустим `GORM`, затем оптимизировать `sqlc` на «горячих» путях.

3) Аутентификация/сессии

- Cookie-сессии, middleware `auth`/`admin`. Пароли — `bcrypt` совместимые. Добавить CSRF для форм в админке.
- Email verification — отдельный маршрут и письмо (отложить, если не критично на старте).

4) Публичные страницы

- Главная, список постов (с пагинацией), страница поста (prev/next/related), список по категориям/тегам.
- «Афоризм дня» — перенести вычисление (`aphorism` таблица) 1:1.

5) Интерактив

- Комментарии (модерация статусом), лайки (cookie-guard как сейчас), подписки на email.
- Поиск — простой LIKE или вынести в отдельный сервис позже.

6) Сайтмап и служебные

- Генератор sitemap.xml. Маршруты `/my-ip`, трекинг визитов (visitor/post_visitor аналог).

7) Админ-панель

- CRUD для категорий/тегов/постов/пользователей/комментариев (+ портфолио/входящие при необходимости).
- Шаблоны: перенести Blade → Go templates. Стили/JS — переиспользовать из `public/*`.

8) Необязательные модули

- Чат (Ratchet → Gorilla WebSocket). Начать с простого WS-хаба, без Pusher.
- Магазин (`packages/shop`) — отложить или вынести в отдельный сервис/модуль Go.

9) Наблюдаемость и эксплуатация

- Метрики, логи (включая пер-пользовательские), pprof, алерты. Добавить ротацию логов/лимит по размеру.

10) Катовер

- Запуск Go-приложения за Traefik, тестирование параллельно. Пошаговый перевод маршрутов на Go. Затем выключение
  `php-fpm`.

---

## 4) Соответствия и подводные камни

- Хеширование паролей: `bcrypt` — сохраняем параметры (cost ~10). Совместимости достаточно для логина существующих
  пользователей.
- Файлы/картинки постов: портировать логику уникальных имен, директорию `public/storage/uploads`. Рассмотреть `embed`
  для инвариантной статики, а user-uploads оставить в volume.
- Слаг/SEO: генерация slug (аналог `Str::slug`). Следить за коллизиями.
- Даты: в моделях есть `date` как строка — в Go стоит нормализовать (`NULL`/`DATE`) и форматировать на view-уровне.
- Посетители/просмотры: перенести `visitor`/`post_visitor`, аккуратно с идемпотентностью, как в Laravel.
- Middleware: CORS/RateLimit/CSRF/Session/Recover — все нужны аналоги.
- Внешние интеграции: Excel (можно отложить), Pusher (заменить WS), `jenssegers/agent` (user-agent парсить через
  `mssola/user_agent` при необходимости), `spatie/laravel-html` — воспроизвести напрямую в шаблонах.

---

## 5) Оценка сложности и сроков

Если цель — «простенький бложик» без чата/магазина:

- Базовое ядро (публичные страницы + админ CRUD + auth + комментарии/лайки + sitemap + подписки): 6–12 рабочих дней.
- Тесты и обвязка (юнит/интеграционные, Docker, CI, метрики): 2–4 дня.
- Данные/катовер (дамп, миграция, валидация): 1–2 дня.
  Итого: ориентир 2–4 недели календарно с буфером.

Если включать чат: +1–3 дня. Модуль shop: +1–2 недели (в зависимости от требований к заказам/оплате/админке).

Факторы риска: объём шаблонов Blade, особенности админ-ролей/прав, зависимость от вспомогательных пакетов (Excel,
Pusher), финальное SEO- соответствие URL.

---

## 6) Рекомендуемые next steps

- Уточнить скоуп: переносим только блог-ядро? (рекомендую начать без chat/shop).
- Выбрать стек доступа к данным (`sqlc` vs `GORM`) и роутер (`chi` vs `gin`).
- Подготовить новый сервис `go-app` в compose и заглушки маршрутов.
- Согласовать схему БД: продолжить на MySQL, мигрировать позже при желании.
- Начать перенос с публичных страниц и аутентификации, затем админ CRUD.

Готов продолжить: могу сразу накидать скелет `go-app` (main, router, middleware, templates, Dockerfile) и протянуть два
первых экрана (главная/пост) для оценки.
