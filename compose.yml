services:
  traefik:
    image: traefik:v3.6.7
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedByDefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.metrics.address=:8082"
      - "--tracing.otlp=true"
      - "--tracing.otlp.http=true"
      - "--tracing.otlp.http.endpoint=http://jaeger:4318/v1/traces"
      - "--tracing.serviceName=traefik"
      - "--tracing.addInternals=true"
      - "--metrics.prometheus=true"
      - "--metrics.prometheus.entryPoint=metrics"
      - "--metrics.prometheus.addEntryPointsLabels=true"
      - "--metrics.prometheus.addRoutersLabels=true"
      - "--metrics.prometheus.addServicesLabels=true"
      - "--metrics.prometheus.buckets=0.1,0.3,1.2,5.0"
      - "--accesslog=true"
      - "--accesslog.filepath=/var/log/traefik/access.log"
      - "--accesslog.format=json"
    ports:
      - "80:80"
    expose:
      - "8082"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "/var/log/traefik:/var/log/traefik"
    networks:
      - app-network

  symfony:
    build:
      context: ./api-symfony
      dockerfile: ./Dockerfile
      target: dev
    env_file:
      - path: ./.env
        required: true
    environment:
      PHP_IDE_CONFIG: serverName=${SERVER_NAME}
      DB_HOST: ${DB_HOST}
      DB_USER: ${MYSQL_ROOT_USER}
      DB_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      DB_NAME: ${MYSQL_DATABASE}
      SERVER_NAME: ":80"
      MAX_REQUESTS: "500"
      GOMEMLIMIT: "512MiB"
    expose:
      - "80"
      - "443"
      - "443/udp"
    volumes:
      - ./api-symfony:/app:rw
      - ./api-symfony/public/storage:/app/public/storage:rw
      - ./api-symfony/Caddyfile:/etc/caddy/Caddyfile:ro
    command: sh -c "php bin/console cache:warmup --no-interaction && frankenphp run --config /etc/caddy/Caddyfile"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.symfony.rule=Host(`phpqas.local`)"
      - "traefik.http.services.symfony.loadbalancer.server.port=80"
    networks:
      - app-network
    restart: unless-stopped
    depends_on:
      - mysql
      - victoria-logs
    healthcheck:
      test: [ "CMD-SHELL", "php -r 'exit(file_get_contents(\"http://127.0.0.1/health\") === \"OK\" ? 0 : 1);'" ]
      interval: 5s
      timeout: 3s
      retries: 6
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  pets-app:
    build:
      context: ./.docker/php-simple
      dockerfile: ./Dockerfile
    env_file:
      - path: ./.env
        required: true
    environment:
      PHP_IDE_CONFIG: serverName=${SERVER_NAME}
      DB_HOST: ${DB_HOST}
      DB_USER: ${MYSQL_ROOT_USER}
      DB_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      DB_NAME: ${MYSQL_DATABASE}
    networks:
      - app-network

  mysql:
    image: mysql:${MYSQL_VERSION}
    container_name: ${DB_HOST}
    environment:
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    volumes:
      - "./data/db/mysql/my.cnf:/etc/mysql/conf.d/my.cnf"
      - "./data/db/mysql/db_data:/var/lib/mysql"
    ports:
      - "8989:3306"
    networks:
      - app-network

  victoria-logs:
    image: victoriametrics/victoria-logs:v1.44.0
    container_name: victoria-logs
    expose:
      - "9428"
    volumes:
      - "./data/victoria-logs:/victoria-logs-data"
    command:
      - -storageDataPath=/victoria-logs-data
      - -retentionPeriod=30d
    networks:
      - app-network
    restart: unless-stopped

  vector:
    image: timberio/vector:nightly-2026-01-30-alpine
    container_name: vector-collector
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./.devops/vmetrics/vector.toml:/etc/vector/vector.toml:ro
    environment:
      VICTORIA_LOGS_HOST: victoria-logs
      VICTORIA_LOGS_PORT: "9428"
    command: -c /etc/vector/vector.toml
    networks:
      - app-network
    restart: unless-stopped
    depends_on:
      - victoria-logs
    labels:
      - "traefik.enable=false"

  vmauth:
    image: victoriametrics/vmauth:v1.134.0
    container_name: vmauth
    expose:
      - "8427"
    volumes:
      - ./.devops/vmetrics/vmauth-entrypoint.sh:/entrypoint.sh:ro
    environment:
      VMAUTH_ADMIN_USER: ${VMAUTH_ADMIN_USER}
      VMAUTH_ADMIN_PASS: ${VMAUTH_ADMIN_PASS}
      VMAUTH_READONLY_USER: ${VMAUTH_READONLY_USER}
      VMAUTH_READONLY_PASS: ${VMAUTH_READONLY_PASS}
    entrypoint: sh /entrypoint.sh
    networks:
      - app-network
    restart: unless-stopped
    depends_on:
      - victoria-logs

  jaeger:
    image: jaegertracing/all-in-one:1.76.0
    container_name: jaeger
    environment:
      COLLECTOR_OTLP_ENABLED: "true"
    expose:
      - "4317"   # OTLP gRPC receiver
      - "4318"   # OTLP HTTP receiver
      - "16686"  # Query UI (web interface)
    networks:
      - app-network
    restart: unless-stopped
    labels:
      - "traefik.enable=false"

networks:
  app-network:
    driver: bridge
